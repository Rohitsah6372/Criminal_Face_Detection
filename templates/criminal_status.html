{% extends 'base.html' %}
{% block content %}
<h2>Criminal Detection Status</h2>
<div class="row mt-3 mb-2">
  <div class="col-md-6">
    <input type="text" id="searchInput" class="form-control" placeholder="Search by criminal name...">
  </div>
  <div class="col-md-6 text-end">
    <button id="refreshBtn" class="btn btn-primary">
      <i class="fas fa-sync-alt"></i> Refresh Status
    </button>
  </div>
</div>

<div class="row mt-3">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">
          <i class="fas fa-users"></i> Criminal Status Board
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="criminal-status-table">
            <thead class="table-dark">
              <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Criminal ID</th>
                <th>Status</th>
                <th>Last Detected</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Criminal status rows will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="fas fa-chart-pie"></i> Status Summary
        </h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <div class="border rounded p-3 bg-success text-white">
              <h3 id="presentCount">0</h3>
              <small>Present</small>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-3 bg-secondary text-white">
              <h3 id="absentCount">0</h3>
              <small>Absent</small>
            </div>
          </div>
        </div>
        <hr>
        <div class="mt-3">
          <h6>Detection Statistics</h6>
          <p class="mb-1"><strong>Total Criminals:</strong> <span id="totalCount">0</span></p>
          <p class="mb-1"><strong>Detection Rate:</strong> <span id="detectionRate">0%</span></p>
          <p class="mb-0"><strong>Last Updated:</strong> <span id="lastUpdated">-</span></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let criminals = [];
let criminalStatus = {};
let previousStatus = {}; // Track previous status for notifications

// Load criminal status data from the new endpoint
function loadCriminalStatusData() {
  fetch('/criminal_status_data')
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        console.error('Error loading status data:', data.error);
        return;
      }
      
      criminals = data.criminals;
      criminalStatus = {};
      
      // Convert to the format expected by the rendering functions
      criminals.forEach(criminal => {
        criminalStatus[criminal.name] = {
          status: criminal.status,
          lastDetected: criminal.last_detected,
          detectionCount: criminal.detection_count
        };
      });
      
      // Check for status changes and show notifications
      checkStatusChanges();
      
      renderCriminalStatus();
      updateSummary(data.summary);
    })
    .catch(error => {
      console.error('Error loading criminal status data:', error);
    });
}

// Check for status changes and show notifications
function checkStatusChanges() {
  criminals.forEach(criminal => {
    const currentStatus = criminal.status;
    const previousStatusForCriminal = previousStatus[criminal.name];
    
    if (previousStatusForCriminal && previousStatusForCriminal !== currentStatus) {
      // Status changed
      if (currentStatus === 'present') {
        showStatusNotification(`${criminal.name} is now PRESENT`, 'success');
      } else if (currentStatus === 'absent') {
        showStatusNotification(`${criminal.name} is now ABSENT`, 'warning');
      }
    }
    
    // Update previous status
    previousStatus[criminal.name] = currentStatus;
  });
}

// Show status change notification
function showStatusNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; left: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    <strong><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}</strong>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(notification);
  
  // Auto-remove after 4 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 4000);
}

// Render criminal status table
function renderCriminalStatus() {
  const tbody = document.querySelector('#criminal-status-table tbody');
  const searchQuery = document.getElementById('searchInput').value.toLowerCase();
  
  let filteredCriminals = criminals;
  if (searchQuery) {
    filteredCriminals = criminals.filter(criminal => 
      criminal.name.toLowerCase().includes(searchQuery) ||
      criminal.criminal_id.toLowerCase().includes(searchQuery)
    );
  }
  
  tbody.innerHTML = filteredCriminals.map(criminal => {
    const status = criminalStatus[criminal.name] || { status: 'absent', lastDetected: null, detectionCount: 0 };
    const statusClass = status.status === 'present' ? 'success' : 'secondary';
    const statusIcon = status.status === 'present' ? 'fa-check-circle' : 'fa-times-circle';
    const statusText = status.status === 'present' ? 'Present' : 'Absent';
    
    return `
      <tr>
        <td>
          <img src="${criminal.image_url}" 
               alt="${criminal.name}" 
               class="rounded" 
               style="width: 50px; height: 50px; object-fit: cover;"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yNSAyNUMyOC4zMTM3IDI1IDMxIDIyLjMxMzcgMzEgMTlDMzEgMTUuNjg2MyAyOC4zMTM3IDEzIDI1IDEzQzIxLjY4NjMgMTMgMTkgMTUuNjg2MyAxOSAxOUMxOSAyMi4zMTM3IDIxLjY4NjMgMjUgMjUgMjVaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yNSAzMEMzMi4xNzkgMzAgMzggMjQuMTc5IDM4IDE3SDM1QzM1IDIyLjUyMiAzMC41MjIgMjcgMjUgMjdDMTkuNDc4IDI3IDE1IDIyLjUyMiAxNSAxN0gxMkMxMiAyNC4xNzkgMTguODIxIDMwIDI1IDMwWiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K'">
        </td>
        <td>
          <strong>${criminal.name}</strong>
          ${status.detectionCount > 0 ? `<br><small class="text-muted">Detected ${status.detectionCount} times</small>` : ''}
        </td>
        <td>${criminal.criminal_id}</td>
        <td>
          <span class="badge bg-${statusClass}">
            <i class="fas ${statusIcon}"></i> ${statusText}
          </span>
        </td>
        <td>
          ${status.lastDetected ? status.lastDetected : 'Never detected'}
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-details" 
                  data-criminal-name="${criminal.name}"
                  title="View detection details">
            <i class="fas fa-eye"></i>
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

// Update summary statistics
function updateSummary(summaryData = null) {
  if (summaryData) {
    // Use data from backend
    document.getElementById('presentCount').textContent = summaryData.present;
    document.getElementById('absentCount').textContent = summaryData.absent;
    document.getElementById('totalCount').textContent = summaryData.total;
    document.getElementById('detectionRate').textContent = `${summaryData.detection_rate}%`;
    document.getElementById('lastUpdated').textContent = summaryData.last_updated;
  } else {
    // Calculate from frontend data (fallback)
    const presentCount = Object.values(criminalStatus).filter(status => status.status === 'present').length;
    const absentCount = Object.values(criminalStatus).filter(status => status.status === 'absent').length;
    const totalCount = criminals.length;
    const detectionRate = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;
    
    document.getElementById('presentCount').textContent = presentCount;
    document.getElementById('absentCount').textContent = absentCount;
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('detectionRate').textContent = `${detectionRate}%`;
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
  }
}

// Show detection details modal
function showDetectionDetails(criminalName) {
  // Find the criminal data
  const criminal = criminals.find(c => c.name === criminalName);
  const recentDetections = criminal ? criminal.recent_detections : [];
  
  let detailsHtml = `
    <div class="modal fade" id="detectionDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detection Details: ${criminalName}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
  `;
  
  if (recentDetections.length > 0) {
    detailsHtml += `
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Detection Type</th>
              <th>Camera</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    recentDetections.slice(0, 10).forEach(detection => {
      detailsHtml += `
        <tr>
          <td>${detection.timestamp}</td>
          <td><span class="badge bg-${getDetectionTypeColor(detection.detection_type)}">${detection.detection_type}</span></td>
          <td>${detection.camera_feed_name || 'Live Camera'}</td>
        </tr>
      `;
    });
    
    detailsHtml += `
          </tbody>
        </table>
      </div>
    `;
  } else {
    detailsHtml += '<p class="text-muted">No detection history available.</p>';
  }
  
  detailsHtml += `
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('detectionDetailsModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Add new modal to page
  document.body.insertAdjacentHTML('beforeend', detailsHtml);
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('detectionDetailsModal'));
  modal.show();
}

// Get color for detection type
function getDetectionTypeColor(type) {
  switch(type) {
    case 'live': return 'danger';
    case 'video': return 'warning';
    case 'cctv': return 'info';
    default: return 'secondary';
  }
}

// Auto-refresh every 3 seconds for real-time updates
function startAutoRefresh() {
  setInterval(() => {
    loadCriminalStatusData();
  }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadCriminalStatusData();
  startAutoRefresh();
  
  // Event listeners
  document.getElementById('searchInput').addEventListener('input', renderCriminalStatus);
  document.getElementById('refreshBtn').addEventListener('click', () => {
    loadCriminalStatusData();
  });
  
  // Event delegation for view details buttons
  document.addEventListener('click', function(e) {
    if (e.target.closest('.view-details')) {
      const button = e.target.closest('.view-details');
      const criminalName = button.getAttribute('data-criminal-name');
      showDetectionDetails(criminalName);
    }
  });
});
</script>

<style>
.table-hover tbody tr:hover {
  background-color: rgba(0,0,0,0.05);
}

.badge {
  font-size: 0.8em;
}

#criminal-status-table img {
  border: 2px solid #dee2e6;
}

#criminal-status-table img:hover {
  border-color: #007bff;
  transform: scale(1.05);
  transition: all 0.2s ease;
}
</style>
{% endblock %} 