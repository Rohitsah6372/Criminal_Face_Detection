{% extends 'base.html' %}
{% block content %}
<h2>Criminal Database</h2>
<div class="row mt-3 mb-2">
  <div class="col-md-6">
    <input type="text" id="searchInput" class="form-control" placeholder="Search by name or ID...">
  </div>
</div>
<div class="table-responsive">
  <table class="table table-bordered" id="criminals-table">
    <thead class="table-dark">
      <tr>
        <th>Image</th>
        <th>Name</th>
        <th>ID</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be populated by JS -->
    </tbody>
  </table>
</div>
<nav>
  <ul class="pagination" id="pagination">
    <!-- Pagination will be populated by JS -->
  </ul>
</nav>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Criminal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-id" name="id">
          <div class="mb-3">
            <label for="edit-name" class="form-label">Name</label>
            <input type="text" class="form-control" id="edit-name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="edit-criminal_id" class="form-label">Criminal ID</label>
            <input type="text" class="form-control" id="edit-criminal_id" name="criminal_id" required>
          </div>
          <div class="mb-3">
            <label for="edit-description" class="form-label">Description</label>
            <textarea class="form-control" id="edit-description" name="description"></textarea>
          </div>
          <div class="mb-3">
            <label for="edit-image" class="form-label">Image (optional)</label>
            <input class="form-control" type="file" id="edit-image" name="image" accept="image/*">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let criminalsData = [];
let filteredData = [];
let currentPage = 1;
const pageSize = 5;

function renderTablePage(page) {
  const tbody = document.querySelector('#criminals-table tbody');
  tbody.innerHTML = '';
  const start = (page - 1) * pageSize;
  const end = start + pageSize;
  const pageData = filteredData.slice(start, end);
  pageData.forEach(c => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><img src="${c.image_url}" alt="${c.name}" width="80" height="80" style="object-fit:cover;"></td>
      <td>${c.name}</td>
      <td>${c.criminal_id}</td>
      <td>${c.description || ''}</td>
      <td>
        <button class="btn btn-sm btn-warning me-2" onclick="editCriminal(${c.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteCriminal(${c.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderPagination() {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const pageCount = Math.ceil(filteredData.length / pageSize);
  for (let i = 1; i <= pageCount; i++) {
    const li = document.createElement('li');
    li.className = 'page-item' + (i === currentPage ? ' active' : '');
    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
    li.onclick = function(e) {
      e.preventDefault();
      currentPage = i;
      renderTablePage(currentPage);
      renderPagination();
    };
    pagination.appendChild(li);
  }
}

function filterData() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  filteredData = criminalsData.filter(c =>
    c.name.toLowerCase().includes(query) ||
    c.criminal_id.toLowerCase().includes(query)
  );
  currentPage = 1;
  renderTablePage(currentPage);
  renderPagination();
}

function loadCriminals() {
  fetch('/criminals')
    .then(res => res.json())
    .then(data => {
      criminalsData = data;
      filteredData = data;
      filterData();
    });
}

document.getElementById('searchInput').addEventListener('input', filterData);

function deleteCriminal(id) {
  if (!confirm('Are you sure you want to delete this criminal?')) return;
  fetch(`/delete_criminal/${id}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      loadCriminals();
    });
}

function editCriminal(id) {
  const c = criminalsData.find(x => x.id === id);
  if (!c) return;
  document.getElementById('edit-id').value = c.id;
  document.getElementById('edit-name').value = c.name;
  document.getElementById('edit-criminal_id').value = c.criminal_id;
  document.getElementById('edit-description').value = c.description || '';
  document.getElementById('edit-image').value = '';
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

document.getElementById('editForm').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('edit-id').value;
  const formData = new FormData(this);
  fetch(`/edit_criminal/${id}`, {
    method: 'POST',
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.status === 'success') {
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        loadCriminals();
      }
    });
};

// Initial load
loadCriminals();
</script>
{% endblock %} 